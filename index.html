<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>SCIONlab Topology</title>
    <meta name="author" content="Fin Christensen">
    <meta name="description" content="Interactive SCIONlab Network Topology">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="node_modules/cytoscape/dist/cytoscape.min.js"></script>
    <script src="node_modules/popper.js/dist/umd/popper.js"></script>
    <script src="node_modules/cytoscape-popper/cytoscape-popper.js"></script>
    <script src="node_modules/tippy.js/dist/tippy-bundle.iife.min.js"></script>
    <script src="node_modules/cytoscape-anywhere-panning/dist/index.js"></script>

    <script defer src="node_modules/es-module-shims/dist/es-module-shims.min.js"></script>
    <script type="importmap-shim" src="importmap.json"></script>
    <script type="module-shim">
      import "@polymer/font-roboto-local";
      import "@polymer/paper-icon-button";
      import "@polymer/iron-icons";
      import "@polymer/paper-toggle-button";
      import "@polymer/paper-card";
      import "@polymer/paper-button";
    </script>

    <link rel="stylesheet" href="node_modules/tippy.js/dist/tippy.css" />
    <link rel="stylesheet" href="node_modules/tippy.js/themes/translucent.css" />

    <style>
      body, html {
        margin: 0;
        padding: 0;
        overflow: hidden;
      }

      #cy {
        width: 100vw;
        height: 100vh;
      }

      #menu {
        margin: 1em;
        position: absolute;
        bottom: 0;
        left: 0;
        width: 320px;
        height: 400px;
        overflow: hidden;
        z-index: 99999;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        transition-property: width, height, border-radius;
        transition-duration: 100ms;
        transition-timing-function: ease-out;
      }

      #menu .card-content {
        line-height: 2em;
        flex-grow: 1;
        width: 320px;
        box-sizing: border-box;
        right: 0;
        top: 0;
        transition-property: right, top;
        transition-duration: 100ms;
        transition-timing-function: ease-out;
      }

      #menu .card-actions {
        width: 320px;
        box-sizing: border-box;
      }

      .tippy-tooltip {
        font-size: 12px;
      }

      #menu.minimized {
        width: 40px;
        height: 40px;
        border-radius: 50%;
      }

      #menu.minimized .card-content {
        right: 264px;
        top: -16px;
      }

      .card-header {
        display: flex;
        margin-bottom: 1em;
      }

      .card-header .card-heading {
        font-size: 24px;
        font-weight: 400;
        line-height: 32px;
        flex-grow: 1;
      }

      .card-header .card-control {
        position: relative;
        width: 40px;
      }

      .card-header .card-control > * {
        position: absolute;
        top: 0;
        left: 0;
        transition-property: opacity;
        transition-duration: 100ms;
        transition-timing-function: ease-out;
      }

      .card-header .card-control .hidden {
        z-index: 0;
        opacity: 0;
      }

      .card-header .card-control :not(.hidden) {
        z-index: 1;
        opacity: 1;
      }

      #open_menu {
        background-color: var(--paper-indigo-500);
        color: white;
        border-radius: 50%;
      }
    </style>
  </head>

  <body>
    <paper-card id="menu">
      <div class="card-content">
        <div class="card-header">
          <span class="card-heading">Show IP Addresses</span>
          <span class="card-control">
            <paper-icon-button id="open_menu" class="hidden" icon="icons:list"></paper-icon-button>
            <paper-icon-button id="close_menu" icon="icons:close"></paper-icon-button>
          </span>
        </div>
        <paper-toggle-button id="mtn">Maintenance Information</paper-toggle-button>
        <paper-toggle-button id="ext">External Network</paper-toggle-button>
        <paper-toggle-button id="gts">AS GTS Internal Network</paper-toggle-button>
        <paper-toggle-button id="dfn">AS DFN Internal Network</paper-toggle-button>
        <paper-toggle-button id="viw">AS VirtualWall Internal Network</paper-toggle-button>
        <paper-toggle-button id="g5k" disabled>AS Grid5000 Internal Network</paper-toggle-button>
        <paper-toggle-button id="exo" disabled>AS ExoGeni Internal Network</paper-toggle-button>
      </div>
      <div class="card-actions">
        <a href="data/fed4fire.json" tabindex="-1"><paper-button>Export JSON</paper-button></a>
        <a href="data/fed4fire.yaml" tabindex="-1"><paper-button>Export YAML</paper-button></a>
      </div>
    </paper-card>

    <div id="cy"></div>

    <script>
      function makeTippy(cy, id, placement, text, offset) {
        let elem = cy.getElementById(id);
        let opts = {};

        if (offset === "src") {
          opts.renderedPosition = () => {
            let src = elem.renderedSourceEndpoint();
            let trg = elem.renderedTargetEndpoint();

            return {
              x: src.x + (trg.x - src.x) * 0.1,
              y: src.y + (trg.y - src.y) * 0.1,
            };
          };
          offset = "0,0";
        } else if (offset === "dst") {
          opts.renderedPosition = () => {
            let src = elem.renderedSourceEndpoint();
            let trg = elem.renderedTargetEndpoint();

            return {
              x: src.x + (trg.x - src.x) * 0.9,
              y: src.y + (trg.y - src.y) * 0.9,
            };
          };
          offset = "0,0";
        } else if (!offset) {
          offset = "0,0";
        }

        let ref = elem.popperRef(opts);

        // unfortunately, a dummy element must be passed
        // as tippy only accepts a dom element as the target
        // https://github.com/atomiks/tippyjs/issues/661
        let dummyDomEle = document.createElement("div");

        let tip = tippy(dummyDomEle, {
          onCreate: (instance) => { // mandatory
            // patch the tippy's popper reference so positioning works
            // https://atomiks.github.io/tippyjs/misc/#custom-position
            instance.popperInstance.reference = ref;
          },
          lazy: false, // mandatory
          trigger: "manual", // mandatory

          // dom element inside the tippy:
          content: () => {
            let div = document.createElement("div");
            div.innerHTML = text;
            return div;
          },

          // your own preferences:
          arrow: true,
          interactive: true,
          appendTo: document.body,
          placement: placement,
          hideOnClick: false,
          multiple: true,
          offset: offset,
          sticky: true,
          theme: "translucent",
        });

        return tip;
      }

      const menu = document.getElementById("menu");
      const open_menu_btn = document.getElementById("open_menu");
      const close_menu_btn = document.getElementById("close_menu");

      open_menu_btn.addEventListener("click", (ev) => {
        menu.classList.remove("minimized");
        open_menu_btn.classList.add("hidden");
        close_menu_btn.classList.remove("hidden");
      });

      close_menu_btn.addEventListener("click", (ev) => {
        menu.classList.add("minimized");
        open_menu_btn.classList.remove("hidden");
        close_menu_btn.classList.add("hidden");
      });

      fetch("data/fed4fire.json")
        .then((response) => {
          return response.json();
        })
        .then((configuration) => {
          const cy = cytoscape({
            container: document.getElementById("cy"),
            wheelSensitivity: 0.25,
            autoungrabify: true,
            style: [
              {
                selector: "node",
                css: {
                  "content": "data(id)",
                  "text-valign": "center",
                  "text-halign": "center",
                  "font-size": "8px",
                  "text-wrap": "wrap",
                  "text-max-width": "25px",
                }
              },
              {
                selector: ":parent",
                css: {
                  "text-valign": "top",
                  "text-halign": "center",
                  "font-size": "12px",
                  "text-wrap": "none",
                }
              },
              {
                selector: "edge",
                css: {
                  "curve-style": "bezier",
                }
              }
            ],
            elements: {
              nodes: [
                { data: { id: "Géant" } },
                { data: { id: "SIDN" } },
                { data: { id: "SWITCH" } },
                { data: { id: "SCMN" } },
                { data: { id: "Vienna" } },
                { data: { id: "OvGU Core" } },
                { data: { id: "OvGU AP" } },
                { data: { id: "DFN" } },
                { data: { id: "Exo Geni" } },
                { data: { id: "Grid 5000" } },
                { data: { id: "VirtualWall" } },
                { data: { id: "KREO NET" } },
                { data: { id: "AMS", parent: "Géant" } },
                { data: { id: "PAR", parent: "Géant" } },
                { data: { id: "HAM", parent: "Géant" } },
                { data: { id: "PRG", parent: "Géant" } },
                { data: { id: "ams0", parent: "AMS" } },
                { data: { id: "ams1", parent: "AMS" } },
                { data: { id: "ams2", parent: "AMS" } },
                { data: { id: "ams3", parent: "AMS" } },
                { data: { id: "ams4", parent: "AMS" } },
                { data: { id: "ams5", parent: "AMS" } },
                { data: { id: "par0", parent: "PAR" } },
                { data: { id: "par1", parent: "PAR" } },
                { data: { id: "par2", parent: "PAR" } },
                { data: { id: "ham0", parent: "HAM" } },
                { data: { id: "ham1", parent: "HAM" } },
                { data: { id: "ham2", parent: "HAM" } },
                { data: { id: "prg0", parent: "PRG" } },
                { data: { id: "prg1", parent: "PRG" } },
                { data: { id: "sidn0", parent: "SIDN" } },
                { data: { id: "sidn1", parent: "SIDN" } },
                { data: { id: "dfn0", parent: "DFN" } },
                { data: { id: "dfn1", parent: "DFN" } },
                { data: { id: "dfn2", parent: "DFN" } },
                { data: { id: "dfn3", parent: "DFN" } },
                { data: { id: "vw0", parent: "VirtualWall" } },
                { data: { id: "vw1", parent: "VirtualWall" } },
              ],
              edges: [
                { data: { id: "sidn0-ams2", source: "sidn0", target: "ams2" } },
                { data: { id: "sidn1-ams3", source: "sidn1", target: "ams3" } },
                { data: { id: "KREO NET-ams4", source: "KREO NET", target: "ams4" } },
                { data: { id: "KREO NET-ams5", source: "KREO NET", target: "ams5" } },
                { data: { id: "SWITCH-par1", source: "SWITCH", target: "par1" } },
                { data: { id: "SWITCH-ham2", source: "SWITCH", target: "ham2" } },
                { data: { id: "dfn0-ham0", source: "dfn0", target: "ham0" } },
                { data: { id: "dfn1-ham1", source: "dfn1", target: "ham1" } },
                { data: { id: "Grid 5000-par0", source: "Grid 5000", target: "par0" } },
                { data: { id: "Grid 5000-par2", source: "Grid 5000", target: "par2" } },
                { data: { id: "vw0-ams1", source: "vw0", target: "ams1" } },
                { data: { id: "vw1-ams0", source: "vw1", target: "ams0" } },
                { data: { id: "vw0-Exo Geni", source: "vw0", target: "Exo Geni" } },
                { data: { id: "vw1-Exo Geni", source: "vw1", target: "Exo Geni" } },
                { data: { id: "vw0-Grid 5000", source: "vw0", target: "Grid 5000" } },
                { data: { id: "vw1-Grid 5000", source: "vw1", target: "Grid 5000" } },
                { data: { id: "prg0-SCMN", source: "prg0", target: "SCMN" } },
                { data: { id: "prg0-OvGU AP", source: "prg0", target: "OvGU AP" } },
                { data: { id: "prg1-Vienna", source: "prg1", target: "Vienna" } },
                { data: { id: "prg1-OvGU Core", source: "prg1", target: "OvGU Core" } },
              ]
            },
            layout: {
              name: "preset",
              positions: {
                par0: { x: 125, y: 300 },
                par1: { x: 125, y: 350 },
                par2: { x: 125, y: 400 },
                ams0: { x: 200, y: 300 },
                ams1: { x: 250, y: 300 },
                ams2: { x: 300, y: 300 },
                ams3: { x: 350, y: 300 },
                ams4: { x: 400, y: 300 },
                ams5: { x: 450, y: 300 },
                ham0: { x: 337.5, y: 400 },
                ham1: { x: 387.5, y: 400 },
                ham2: { x: 437.5, y: 400 },
                prg0: { x: 212.5, y: 400 },
                prg1: { x: 262.5, y: 400 },
                sidn0: { x: 300, y: 175 },
                sidn1: { x: 350, y: 175 },
                "KREO NET": { x: 425, y: 175 },
                SWITCH: { x: 575, y: 350 },
                "Grid 5000": { x: 0, y: 300 },
                "Exo Geni": { x: 175, y: 175 },
                vw0: { x: 75, y: 150 },
                vw1: { x: 75, y: 200 },
                dfn0: { x: 387.5, y: 500 },
                dfn1: { x: 437.5, y: 500 },
                dfn2: { x: 387.5, y: 550 },
                dfn3: { x: 437.5, y: 550 },
                "OvGU AP": { x: 162.5, y: 500 },
                SCMN: { x: 212.5, y: 550 },
                "OvGU Core": { x: 262.5, y: 500 },
                Vienna: { x: 312.5, y: 550 },
              },
            },
          });

          cy.anywherePanning();

          const mtn_toggle = document.getElementById("mtn");
          const ext_toggle = document.getElementById("ext");
          const gts_toggle = document.getElementById("gts");
          const dfn_toggle = document.getElementById("dfn");
          const viw_toggle = document.getElementById("viw");
          const g5k_toggle = document.getElementById("g5k");
          const exo_toggle = document.getElementById("exo");

          const mtn_tip = {
            "vw0": "bottom",
            "vw1": "bottom",
            "ams0": "top",
            "ams1": "bottom",
            "ams2": "top",
            "ams3": "bottom",
            "ams4": "top",
            "ams5": "bottom",
            "par0": "left",
            "par1": "left",
            "par2": "left",
            "ham0": "top",
            "ham1": "bottom",
            "ham2": "top",
            "prg0": "top",
            "prg1": "bottom",
            "dfn0": "left",
            "dfn1": "right",
            "dfn2": "left",
            "dfn3": "right",
            "SWITCH": "top",
          };

          const mtn_cfg = configuration["Maintenance information"];
          const mtn = Object.keys(mtn_cfg).map((hostname, _index) => {
            let tooltip = `${mtn_cfg[hostname].address}`;
            if (!!mtn_cfg[hostname].host_id) {
              tooltip += `<br>${mtn_cfg[hostname].host_id}`;
            }
            return makeTippy(cy, hostname, mtn_tip[hostname], tooltip);
          });

          const ext_tip = {
            "vw0-ams1": {
              "src": "bottom",
              "dst": "right",
            },
            "sidn0-ams2": {
              "src": "bottom",
              "dst": "top",
            },
            "sidn1-ams3": {
              "src": "bottom",
              "dst": "top",
            },
            "KREO NET-ams4": {
              "src": "left",
              "dst": "top",
            },
            "KREO NET-ams5": {
              "src": "right",
              "dst": "top",
            },
            "SWITCH-par1": {
              "src": "left",
              "dst": "right",
            },
            "vw1-ams0": {
              "src": "bottom",
              "dst": "top",
            },
            "Grid 5000-par0": {
              "src": "bottom",
              "dst": "bottom",
            },
            "Grid 5000-par2": {
              "src": "bottom",
              "dst": "bottom",
            },
            "dfn0-ham0": {
              "src": "top",
              "dst": "bottom",
            },
            "dfn1-ham1": {
              "src": "top",
              "dst": "bottom",
            },
            "SWITCH-ham2": {
              "src": "bottom",
              "dst": "bottom",
            },
            "prg0-SCMN": {
              "src": "bottom",
              "dst": "top",
            },
            "prg0-OvGU AP": {
              "src": "left",
              "dst": "top",
            },
            "prg1-Vienna": {
              "src": "right",
              "dst": "top",
            },
            "prg1-OvGU Core": {
              "src": "top",
              "dst": "top",
            },
            "vw0-Grid 5000": {
              "src": "left",
              "dst": "top",
            },
            "vw0-Exo Geni": {
              "src": "top",
              "dst": "top",
            },
            "vw1-Grid 5000": {
              "src": "left",
              "dst": "right",
            },
            "vw1-Exo Geni": {
              "src": "bottom",
              "dst": "bottom",
            },
          };

          const ext_cfg = configuration["External links"];
          const ext = Object.keys(ext_cfg).flatMap((edge_name, _index) => {
            let tooltipSrc = ext_cfg[edge_name].src.address;
            if (!!ext_cfg[edge_name].src.interface) {
              tooltipSrc += ` @ ${ext_cfg[edge_name].src.interface}`;
            }
            if (!!ext_cfg[edge_name].src.vlan) {
              tooltipSrc += `<br>${ext_cfg[edge_name].src.vlan}`;
            }

            let tooltipDst = ext_cfg[edge_name].dst.address;
            if (!!ext_cfg[edge_name].dst.interface) {
              tooltipDst += ` @ ${ext_cfg[edge_name].dst.interface}`;
            }
            if (!!ext_cfg[edge_name].dst.vlan) {
              tooltipDst += `<br>${ext_cfg[edge_name].dst.vlan}`;
            }

            return [
              makeTippy(cy, edge_name, ext_tip[edge_name].src, tooltipSrc, "src"),
              makeTippy(cy, edge_name, ext_tip[edge_name].dst, tooltipDst, "dst"),
            ];
          });

            const gts_tip = {
              "ams0": "bottom",
              "ams1": "bottom",
              "ams2": "bottom",
              "ams3": "bottom",
              "ams4": "bottom",
              "ams5": "bottom",
              "par0": "right",
              "par1": "right",
              "par2": "right",
              "ham0": "top",
              "ham1": "top",
              "ham2": "top",
              "prg0": "top",
              "prg1": "top",
            };
            const gts_intern = configuration["GTS internal network"];
            const gts = Object.keys(gts_intern).map((hostname, _index) => {
              return makeTippy(cy, hostname, gts_tip[hostname], gts_intern[hostname].address);
            });

            const dfn_tip = {
              "dfn0": "top",
              "dfn1": "top",
              "dfn2": "top",
              "dfn3": "top",
            };
            const dfn_intern = configuration["DFN internal network"];
            const dfn = Object.keys(dfn_intern).map((hostname, _index) => {
              return makeTippy(cy, hostname, dfn_tip[hostname], dfn_intern[hostname].address);
            });

            const viw_tip = {
              "vw0": "top",
              "vw1": "top",
            };
            const viw_intern = configuration["VWall internal network"];
            const viw = Object.keys(viw_intern).map((hostname, _index) => {
              return makeTippy(cy, hostname, viw_tip[hostname], viw_intern[hostname].address);
            });

            // TBD: g5k & exogeni
            const g5k = [
            ];
            const exo = [
            ];

            mtn_toggle.addEventListener("change", (ev) => {
              if (ev.target.checked) {
                mtn.forEach(tip => tip.show());
              } else {
                mtn.forEach(tip => tip.hide());
              }
            });
            ext_toggle.addEventListener("change", (ev) => {
              if (ev.target.checked) {
                ext.forEach(tip => tip.show());
              } else {
                ext.forEach(tip => tip.hide());
              }
            });
            gts_toggle.addEventListener("change", (ev) => {
              if (ev.target.checked) {
                gts.forEach(tip => tip.show());
              } else {
                gts.forEach(tip => tip.hide());
              }
            });
            dfn_toggle.addEventListener("change", (ev) => {
              if (ev.target.checked) {
                dfn.forEach(tip => tip.show());
              } else {
                dfn.forEach(tip => tip.hide());
              }
            });
            viw_toggle.addEventListener("change", (ev) => {
              if (ev.target.checked) {
                viw.forEach(tip => tip.show());
              } else {
                viw.forEach(tip => tip.hide());
              }
            });
            g5k_toggle.addEventListener("change", (ev) => {
              if (ev.target.checked) {
                g5k.forEach(tip => tip.show());
              } else {
                g5k.forEach(tip => tip.hide());
              }
            });
            exo_toggle.addEventListener("change", (ev) => {
              if (ev.target.checked) {
                exo.forEach(tip => tip.show());
              } else {
                exo.forEach(tip => tip.hide());
              }
            });

            window.cy = cy;
        });
    </script>
  </body>
</html>
